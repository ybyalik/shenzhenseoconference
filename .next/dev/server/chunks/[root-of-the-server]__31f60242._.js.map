{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/runner/workspace/app/api/aweber-subscribe/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\n\nconst AWEBER_API_BASE = 'https://api.aweber.com/1.0';\nconst AWEBER_TOKEN_URL = 'https://auth.aweber.com/oauth2/token';\n\n// In-memory cache for refreshed access token\nlet cachedAccessToken: string | null = null;\nlet tokenExpiresAt: number = 0;\n\nasync function refreshAccessToken(): Promise<string> {\n  const refreshToken = process.env.AWEBER_REFRESH_TOKEN;\n  const clientId = process.env.AWEBER_CLIENT_ID;\n  const clientSecret = process.env.AWEBER_CLIENT_SECRET;\n\n  if (!refreshToken || !clientId || !clientSecret) {\n    throw new Error('Missing OAuth credentials for token refresh');\n  }\n\n  const params = new URLSearchParams({\n    grant_type: 'refresh_token',\n    refresh_token: refreshToken,\n  });\n\n  const response = await fetch(AWEBER_TOKEN_URL, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/x-www-form-urlencoded',\n      'Authorization': `Basic ${Buffer.from(`${clientId}:${clientSecret}`).toString('base64')}`,\n    },\n    body: params,\n  });\n\n  if (!response.ok) {\n    const error = await response.json().catch(() => ({}));\n    console.error('Token refresh failed:', error);\n    throw new Error('Failed to refresh access token');\n  }\n\n  const data = await response.json();\n  cachedAccessToken = data.access_token;\n  tokenExpiresAt = Date.now() + (data.expires_in * 1000) - 60000; // Refresh 1 min before expiry\n\n  console.log('Access token refreshed successfully');\n  return data.access_token;\n}\n\nasync function getValidAccessToken(): Promise<string> {\n  // Check if we have a cached token that hasn't expired\n  if (cachedAccessToken && Date.now() < tokenExpiresAt) {\n    return cachedAccessToken;\n  }\n\n  // Try using the token from environment first\n  const envToken = process.env.AWEBER_ACCESS_TOKEN;\n  if (envToken && !cachedAccessToken) {\n    cachedAccessToken = envToken;\n    tokenExpiresAt = Date.now() + 3600000; // Assume 1 hour validity\n    return envToken;\n  }\n\n  // Refresh the token\n  return await refreshAccessToken();\n}\n\nasync function addSubscriber(email: string, name?: string): Promise<Response> {\n  const accountId = process.env.AWEBER_ACCOUNT_ID;\n  const listId = process.env.AWEBER_LIST_ID;\n\n  if (!accountId || !listId) {\n    throw new Error('Missing AWeber account or list ID');\n  }\n\n  const accessToken = await getValidAccessToken();\n  const subscribersUrl = `${AWEBER_API_BASE}/accounts/${accountId}/lists/${listId}/subscribers`;\n\n  const subscriberData = {\n    email,\n    ...(name && { name }),\n    tags: ['early-bird-notification', 'website-signup'],\n    ad_tracking: 'website-early-bird-form',\n  };\n\n  const response = await fetch(subscribersUrl, {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Authorization': `Bearer ${accessToken}`,\n    },\n    body: JSON.stringify(subscriberData),\n  });\n\n  // If token is invalid, refresh and retry once\n  if (response.status === 401) {\n    console.log('Access token expired, refreshing...');\n    const newToken = await refreshAccessToken();\n    \n    return await fetch(subscribersUrl, {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json',\n        'Authorization': `Bearer ${newToken}`,\n      },\n      body: JSON.stringify(subscriberData),\n    });\n  }\n\n  return response;\n}\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json();\n    const { email, name } = body;\n\n    if (!email) {\n      return NextResponse.json(\n        { error: 'Email is required' },\n        { status: 400 }\n      );\n    }\n\n    // Add subscriber to AWeber list\n    const response = await addSubscriber(email, name);\n\n    if (response.ok) {\n      const locationHeader = response.headers.get('location');\n      \n      return NextResponse.json({\n        success: true,\n        message: 'Successfully subscribed to Early Bird notifications',\n        subscriberUrl: locationHeader,\n      });\n    } else {\n      const errorData = await response.json().catch(() => ({}));\n      \n      // Check if subscriber already exists\n      if (response.status === 400 && errorData.error?.message?.includes('already subscribed')) {\n        return NextResponse.json(\n          { error: 'Email already subscribed to our list' },\n          { status: 400 }\n        );\n      }\n\n      console.error('AWeber API error:', errorData);\n      return NextResponse.json(\n        { error: errorData.error?.message || 'Failed to subscribe' },\n        { status: response.status }\n      );\n    }\n  } catch (error: any) {\n    console.error('AWeber subscription error:', error);\n    return NextResponse.json(\n      { error: error.message || 'Internal server error' },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}